<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Blossom Music Generator</title>
    <style>
      body {
        margin: 0;
        padding: 1rem;
        background: #111;
        color: #fff;
        font-family: sans-serif;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .row {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      select, input, button {
        padding: 0.4rem;
      }
      #logs {
        background: #222;
        padding: 0.5rem;
        flex: 1;
        overflow-y: auto;
      }
      progress {
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div class="row">
      <label>Preset <select id="preset"></select></label>
      <label>Style <select id="style"><option value="">(default)</option></select></label>
      <label>Seed <input type="number" id="seed" value="42" /></label>
      <label>Minutes <input type="number" step="0.1" id="minutes" /></label>
    </div>
    <div class="row">
      <button id="start-btn">Start</button>
      <button id="cancel-btn" style="display:none;">Cancel</button>
      <button id="download-btn" style="display:none;">Download bundle</button>
    </div>
    <progress id="progress" value="0" max="100"></progress>
    <div id="eta"></div>
    <pre id="logs"></pre>
    <script>
      const { invoke } = window.__TAURI__;
      const presetSel = document.getElementById('preset');
      const styleSel = document.getElementById('style');
      const seedInput = document.getElementById('seed');
      const minInput = document.getElementById('minutes');
      const startBtn = document.getElementById('start-btn');
      const cancelBtn = document.getElementById('cancel-btn');
      const downloadBtn = document.getElementById('download-btn');
      const prog = document.getElementById('progress');
      const eta = document.getElementById('eta');
      const logs = document.getElementById('logs');
      let bundlePath = null;

      async function loadOptions() {
        try {
          const presets = await invoke('list_presets');
          presets.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p; opt.textContent = p;
            presetSel.appendChild(opt);
          });
          if (presets.length) presetSel.value = presets[0];
          const styles = await invoke('list_styles');
          styles.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s; opt.textContent = s;
            styleSel.appendChild(opt);
          });
        } catch (e) {
          logs.textContent += e + '\n';
        }
      }

      window.__TAURI__.event.listen('log', e => {
        logs.textContent += e.payload + '\n';
        logs.scrollTop = logs.scrollHeight;
      });
      window.__TAURI__.event.listen('progress', e => {
        prog.value = e.payload;
      });
      window.__TAURI__.event.listen('eta', e => {
        eta.textContent = 'ETA: ' + e.payload;
      });
      window.__TAURI__.event.listen('result', e => {
        bundlePath = e.payload;
        downloadBtn.style.display = 'inline-block';
        cancelBtn.style.display = 'none';
        startBtn.disabled = false;
      });
      window.__TAURI__.event.listen('error', e => {
        logs.textContent += 'Error: ' + e.payload + '\n';
        cancelBtn.style.display = 'none';
        startBtn.disabled = false;
      });

      startBtn.addEventListener('click', async () => {
        logs.textContent = '';
        downloadBtn.style.display = 'none';
        prog.value = 0;
        eta.textContent = '';
        startBtn.disabled = true;
        cancelBtn.style.display = 'inline-block';
        bundlePath = null;
        await invoke('start_render', {
          preset: presetSel.value,
          style: styleSel.value,
          seed: parseInt(seedInput.value),
          minutes: minInput.value ? parseFloat(minInput.value) : null
        });
      });

      cancelBtn.addEventListener('click', async () => {
        await invoke('cancel_render');
        cancelBtn.style.display = 'none';
        startBtn.disabled = false;
      });

      downloadBtn.addEventListener('click', () => {
        if (bundlePath) {
          window.__TAURI__.shell.open(bundlePath);
        }
      });

      loadOptions();
    </script>
  </body>
</html>
