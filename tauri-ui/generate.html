<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Blossom Music Generator</title>
    <style>
      body {
        margin: 0;
        padding: 1rem;
        background: #111;
        color: #fff;
        font-family: sans-serif;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .row {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      select, input, button {
        padding: 0.4rem;
      }
      #logs {
        background: #222;
        padding: 0.5rem;
        flex: 1;
        overflow-y: auto;
      }
      progress {
        flex: 1;
      }
      #progbar {
        align-items: center;
      }
    </style>
  </head>
  <body>
    <div class="row">
      <label>Preset <select id="preset"></select></label>
      <label>Style <select id="style"><option value="">(default)</option></select></label>
      <label>Seed <input type="number" id="seed" value="42" /></label>
      <label>Minutes <input type="number" step="0.1" id="minutes" /></label>
    </div>
    <div class="row">
      <button id="start-btn">Start</button>
      <button id="cancel-btn" style="display:none;">Cancel</button>
      <button id="download-btn" style="display:none;">Download bundle</button>
    </div>
    <div id="progbar" class="row">
      <progress id="progress" value="0" max="100"></progress>
      <div id="stage"></div>
    </div>
    <div id="eta"></div>
    <pre id="logs"></pre>
    <div id="results" style="display:none;">
      <h3>Results</h3>
      <ul id="summary"></ul>
    </div>
    <script>
      const { invoke, event } = window.__TAURI__;
      const presetSel = document.getElementById('preset');
      const styleSel = document.getElementById('style');
      const seedInput = document.getElementById('seed');
      const minInput = document.getElementById('minutes');
      const startBtn = document.getElementById('start-btn');
      const cancelBtn = document.getElementById('cancel-btn');
      const downloadBtn = document.getElementById('download-btn');
      const prog = document.getElementById('progress');
      const stage = document.getElementById('stage');
      const eta = document.getElementById('eta');
      const logs = document.getElementById('logs');
      let bundlePath = null;
      let currentJobId = null;
      let unlistenProgress = null;

      async function loadOptions() {
        try {
          const presets = await invoke('list_presets');
          presets.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p; opt.textContent = p;
            presetSel.appendChild(opt);
          });
          if (presets.length) presetSel.value = presets[0];
          const styles = await invoke('list_styles');
          styles.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s; opt.textContent = s;
            styleSel.appendChild(opt);
          });
        } catch (e) {
          logs.textContent += e + '\n';
        }
      }

      let pollTimeout = null;

      async function poll() {
        if (currentJobId === null) return;
        try {
          const data = await invoke('job_status', { jobId: currentJobId });
          if (data === 'Running') {
            pollTimeout = setTimeout(poll, 1000);
          } else if (typeof data === 'object' && 'Completed' in data) {
            cancelBtn.style.display = 'none';
            startBtn.disabled = false;
            if (typeof unlistenProgress === 'function') {
              unlistenProgress();
              unlistenProgress = null;
            }
          }
        } catch (e) {
          logs.textContent += 'Error: ' + e + '\n';
          cancelBtn.style.display = 'none';
          startBtn.disabled = false;
        }
      }

      startBtn.addEventListener('click', async () => {
        logs.textContent = '';
        downloadBtn.style.display = 'none';
        prog.value = 0;
        eta.textContent = '';
        startBtn.disabled = true;
        cancelBtn.style.display = 'inline-block';
        bundlePath = null;
        const args = ['main_render.py', '--preset', presetSel.value, '--seed', String(parseInt(seedInput.value))];
        if (styleSel.value) args.push('--style', styleSel.value);
        if (minInput.value) args.push('--minutes', String(parseFloat(minInput.value)));
        args.push('--bundle');
        currentJobId = await invoke('start_job', { args });
        unlistenProgress = await event.listen(`progress::${currentJobId}`, (e) => {
          const data = e.payload;
          if (typeof data.percent === 'number') prog.value = data.percent;
          stage.textContent = data.stage || '';
          eta.textContent = data.eta ? 'ETA: ' + data.eta : '';
          if (data.message) {
            logs.textContent += data.message + '\n';
            logs.scrollTop = logs.scrollHeight;
          }
        });
        poll();
      });

      cancelBtn.addEventListener('click', async () => {
        if (currentJobId !== null) {
          await invoke('cancel_render', { jobId: currentJobId });
        }
      });

      downloadBtn.addEventListener('click', () => {
        if (bundlePath) {
          window.__TAURI__.shell.open(bundlePath);
        }
      });

      loadOptions();
    </script>
  </body>
</html>
