<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Blossom Music Generator</title>
    <style>
      body {
        margin: 0;
        padding: 1rem;
        background: #111;
        color: #fff;
        font-family: sans-serif;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .row {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      select, input, button {
        padding: 0.4rem;
      }
      #logs {
        background: #222;
        padding: 0.5rem;
        flex: 1;
        overflow-y: auto;
      }
      progress {
        flex: 1;
      }
      #progbar {
        align-items: center;
      }
    </style>
  </head>
  <body>
    <div class="row" id="inputs">
      <label>Preset <select id="preset"></select></label>
      <label>Style <select id="style"><option value="">(default)</option></select></label>
      <label>Minutes <input type="number" step="0.1" id="minutes" /></label>
      <label>Sections <input type="number" id="sections" /></label>
      <label>Seed <input type="number" id="seed" value="42" /></label>
      <label>Output name <input type="text" id="name" value="output" /></label>
      <label>Output folder
        <input type="text" id="outdir" readonly />
        <button id="choose_outdir" type="button">üìÅ</button>
      </label>
    </div>

    <details id="advanced">
      <summary>Advanced</summary>
      <label>Mix config <input type="file" id="mix_config" accept=".json,application/json" /></label>
      <label>Arrange config <input type="file" id="arrange_config" accept=".json,application/json" /></label>
      <label><input type="checkbox" id="phrase" /> Phrase backend</label>
      <label>Preview bars <input type="number" id="preview" /></label>
    </details>

    <div class="row">
      <button id="start-btn">Start</button>
      <button id="cancel-btn" style="display:none;">Cancel</button>
      <button id="download-btn" style="display:none;">Download bundle</button>
    </div>
    <div id="progbar" class="row">
      <progress id="progress" value="0" max="100"></progress>
      <div id="stage"></div>
    </div>
    <div id="eta"></div>
    <pre id="logs"></pre>
    <div id="results" style="display:none;">
      <h3>Results</h3>
      <ul id="summary"></ul>
    </div>
    <div id="recent">
      <h3>Recent Renders</h3>
      <ul id="recent_list"></ul>
    </div>
    <script>
      const { invoke } = window.__TAURI__;
      const presetSel = document.getElementById('preset');
      const styleSel = document.getElementById('style');
      const seedInput = document.getElementById('seed');
      const minInput = document.getElementById('minutes');
      const sectionsInput = document.getElementById('sections');
      const nameInput = document.getElementById('name');
      const outdirInput = document.getElementById('outdir');
      const chooseOutdirBtn = document.getElementById('choose_outdir');
      const mixConfigInput = document.getElementById('mix_config');
      const arrangeConfigInput = document.getElementById('arrange_config');
      const phraseInput = document.getElementById('phrase');
      const previewInput = document.getElementById('preview');
      const startBtn = document.getElementById('start-btn');
      const cancelBtn = document.getElementById('cancel-btn');
      const downloadBtn = document.getElementById('download-btn');
      const prog = document.getElementById('progress');
      const stage = document.getElementById('stage');
      const eta = document.getElementById('eta');
      const logs = document.getElementById('logs');
      const recentList = document.getElementById('recent_list');
      const { readTextFile, writeTextFile, BaseDirectory } = window.__TAURI__.fs;
      let bundlePath = null;
      let currentJobId = null;
      let outputDir = '';
      let currentParams = null;
      const MAX_RECENT = 10;

      async function loadOptions() {
        try {
          const presets = await invoke('list_presets');
          presets.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p; opt.textContent = p;
            presetSel.appendChild(opt);
          });
          if (presets.length) presetSel.value = presets[0];
          const styles = await invoke('list_styles');
          styles.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s; opt.textContent = s;
            styleSel.appendChild(opt);
          });
        } catch (e) {
          logs.textContent += e + '\n';
        }
      }

      function fillForm(job) {
        presetSel.value = job.preset;
        styleSel.value = job.style || '';
        minInput.value = job.minutes ?? '';
        sectionsInput.value = job.sections ?? '';
        seedInput.value = job.seed ?? 42;
        nameInput.value = job.name || 'output';
        phraseInput.checked = !!job.phrase;
        previewInput.value = job.preview ?? '';
        outputDir = job.outdir || '';
        outdirInput.value = outputDir;
      }

      async function readRecent() {
        try {
          const text = await readTextFile('recent_renders.json', { dir: BaseDirectory.App });
          return JSON.parse(text);
        } catch {
          return [];
        }
      }

      async function writeRecent(entries) {
        const json = JSON.stringify(entries.slice(-MAX_RECENT), null, 2);
        await writeTextFile('recent_renders.json', json, { dir: BaseDirectory.App });
      }

      async function loadRecent() {
        const data = await readRecent();
        if (!recentList) return;
        recentList.innerHTML = '';
        data.slice().reverse().forEach(job => {
          const li = document.createElement('li');
          const span = document.createElement('span');
          span.textContent = `${job.preset} (seed ${job.seed}) - ${job.status}`;
          const btn = document.createElement('button');
          btn.textContent = 'Duplicate';
          btn.onclick = () => fillForm(job);
          li.appendChild(span);
          li.appendChild(btn);
          recentList.appendChild(li);
        });
      }

      async function addRecent(entry) {
        const entries = await readRecent();
        entries.push(entry);
        await writeRecent(entries);
      }

      let pollTimeout = null;
      let progressUnlisten = null;

      async function poll() {
        if (currentJobId === null) return;
        try {
          const data = await invoke('job_status', { jobId: currentJobId });
          if (data.status === 'running') {
            pollTimeout = setTimeout(poll, 1000);
          } else {
            cancelBtn.style.display = 'none';
            startBtn.disabled = false;
            if (progressUnlisten) { progressUnlisten(); progressUnlisten = null; }
            if (data.status === 'error') {
              logs.textContent += 'Error: job failed\n';
            }
            if (currentParams) {
              await addRecent({ ...currentParams, status: data.status });
              loadRecent();
            }
          }
        } catch (e) {
          logs.textContent += 'Error: ' + e + '\n';
          cancelBtn.style.display = 'none';
          startBtn.disabled = false;
          if (progressUnlisten) { progressUnlisten(); progressUnlisten = null; }
        }
      }

      chooseOutdirBtn.addEventListener('click', async () => {
        const selected = await window.__TAURI__.dialog.open({ directory: true, multiple: false });
        if (selected) {
          outputDir = Array.isArray(selected) ? selected[0] : selected;
          outdirInput.value = outputDir;
        }
      });

      startBtn.addEventListener('click', async () => {
        logs.textContent = '';
        downloadBtn.style.display = 'none';
        prog.value = 0;
        eta.textContent = '';
        startBtn.disabled = true;
        cancelBtn.style.display = 'inline-block';
        bundlePath = null;
        const seed = parseInt(seedInput.value);
        if (Number.isNaN(seed)) {
          logs.textContent = 'Invalid seed\n';
          startBtn.disabled = false;
          cancelBtn.style.display = 'none';
          return;
        }
        const args = ['main_render.py', '--preset', presetSel.value, '--seed', String(seed)];
        if (styleSel.value) args.push('--style', styleSel.value);
        if (minInput.value) {
          const mins = parseFloat(minInput.value);
          if (Number.isNaN(mins)) {
            logs.textContent = 'Invalid minutes\n';
            startBtn.disabled = false;
            cancelBtn.style.display = 'none';
            return;
          }
          args.push('--minutes', String(mins));
        }
        if (sectionsInput.value) {
          const secs = parseInt(sectionsInput.value);
          if (Number.isNaN(secs)) {
            logs.textContent = 'Invalid sections\n';
            startBtn.disabled = false;
            cancelBtn.style.display = 'none';
            return;
          }
          args.push('--sections', String(secs));
        }
        if (phraseInput.checked) args.push('--use-phrase-model', 'yes');
        if (previewInput.value) {
          const prev = parseInt(previewInput.value);
          if (Number.isNaN(prev)) {
            logs.textContent = 'Invalid preview bars\n';
            startBtn.disabled = false;
            cancelBtn.style.display = 'none';
            return;
          }
          args.push('--preview', String(prev));
        }
        const tempDir = await window.__TAURI__.path.tempDir();
        const mixFile = mixConfigInput.files[0];
        if (mixFile) {
          const mixCfgPath = await window.__TAURI__.path.join(
            tempDir,
            `mix-config-${Date.now()}.json`
          );
          await window.__TAURI__.fs.writeFile({
            path: mixCfgPath,
            contents: await mixFile.text()
          });
          args.push('--mix-config', mixCfgPath);
        }
        const arrFile = arrangeConfigInput.files[0];
        if (arrFile) {
          const arrCfgPath = await window.__TAURI__.path.join(
            tempDir,
            `arrange-config-${Date.now()}.json`
          );
          await window.__TAURI__.fs.writeFile({
            path: arrCfgPath,
            contents: await arrFile.text()
          });
          args.push('--arrange-config', arrCfgPath);
        }
        const name = nameInput.value.trim() || 'output';
        const mixPath = outputDir ? `${outputDir}/${name}.wav` : `${name}.wav`;
        const stemsPath = outputDir ? `${outputDir}/${name}_stems` : `${name}_stems`;
        args.push('--mix', mixPath);
        args.push('--stems', stemsPath);
        if (outputDir) {
          args.push('--bundle', `${outputDir}/${name}`);
        } else {
          args.push('--bundle');
        }
        currentParams = {
          preset: presetSel.value,
          style: styleSel.value || '',
          minutes: minInput.value ? parseFloat(minInput.value) : undefined,
          sections: sectionsInput.value ? parseInt(sectionsInput.value) : undefined,
          seed,
          name,
          phrase: phraseInput.checked,
          preview: previewInput.value ? parseInt(previewInput.value) : undefined,
          outdir: outputDir || ''
        };
        currentJobId = await invoke('start_job', { args });
        if (progressUnlisten) { progressUnlisten(); }
        progressUnlisten = await window.__TAURI__.event.listen(`progress::${currentJobId}`, e => {
          const data = e.payload;
          if (data.message) {
            logs.textContent += data.message + '\n';
            logs.scrollTop = logs.scrollHeight;
          }
          if (typeof data.percent === 'number') prog.value = data.percent;
          stage.textContent = data.stage || '';
          eta.textContent = data.eta ? 'ETA: ' + data.eta : '';
        });
        poll();
      });

      cancelBtn.addEventListener('click', async () => {
        if (currentJobId !== null) {
          await invoke('cancel_render', { jobId: currentJobId });
        }
      });

      downloadBtn.addEventListener('click', () => {
        if (bundlePath) {
          window.__TAURI__.shell.open(bundlePath);
        }
      });

      loadOptions();
      loadRecent();
    </script>
  </body>
</html>
